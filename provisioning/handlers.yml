---
# https://github.com/ansible/ansible/issues/14413#issuecomment-304337420
- name: reboot
  command: shutdown -r now "Ansible triggered a reboot"
  async: 0
  poll: 0
  ignore_errors: true
  notify: wait for server to come back
  become: true

- name: wait for server to come back
  local_action: wait_for
  args:
    host: "{{ ansible_ssh_host|default(inventory_hostname) }}"
    port: "{{ ansible_ssh_port|default(22) }}"
    delay: 60
    state: started

- name: restart postfix
  service:
    name: postfix
    state: restarted
  become: true

- name: restart dnsmasq
  service:
    name: dnsmasq
    state: restarted
  become: true

- name: restart openvpn
  service:
    name: openvpn
    state: restarted
    sleep: 3
  become: true
  notify: restart shorewall

- name: restart apache
  service:
    name: httpd
    state: restarted
  become: true

- name: restart postgresql
  service:
    name: postgresql-9.6
    state: restarted
  become: true

- name: restart uWSGI
  supervisorctl:
    name: uwsgi
    state: restarted
    supervisorctl_path: /opt/miniconda/bin/supervisorctl

- name: restart datastore config server
  supervisorctl:
    name: datastore-config-server
    state: restarted
    supervisorctl_path: /opt/miniconda/bin/supervisorctl

- name: restart nagios
  service:
    name: nagios
    state: restarted
  become: true
  # notify: restart nsca

- name: restart nsca
  service:
    name: nsca
    state: restarted
  become: true

- name: restart supervisord
  service:
    name: supervisord
    state: restarted
  become: true

- name: restart hisparcvpnd
  supervisorctl:
    name: hisparcvpnd
    state: restarted

- name: restart shorewall
  service:
    name: shorewall
    state: restarted
  become: true

- name: compile firewall rules
  command: lokkit --update
  become: true
