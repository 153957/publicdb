- name: ensure /srv directory exists
  file: path=/srv state=directory
  sudo: yes

- name: ensure /srv/publicdb directory exists
  file: path=/srv/publicdb state=directory
        owner=hisparc group=hisparc mode=2775
  sudo: yes

- name: set default group write ACLs on /srv/publicdb
  command: /usr/bin/setfacl -m d:g::rwx /srv/publicdb
  sudo: yes

- name: link publicdb sources to /srv/publicdb
  file: path=/srv/publicdb/www src=/vagrant/django_publicdb state=link

- name: create django static folder
  file: path=/srv/publicdb/static state=directory

- name: install python packages in virtualenv -- stage 1
  pip: virtualenv=/srv/publicdb/publicdb_env
       requirements=/vagrant/provisioning/pip-stage1.txt

- name: install python packages in virtualenv -- stage 2
  pip: virtualenv=/srv/publicdb/publicdb_env
       requirements=/vagrant/provisioning/pip-stage2.txt

- name: install python packages in virtualenv -- stage 3
  pip: virtualenv=/srv/publicdb/publicdb_env
       requirements=/vagrant/provisioning/pip-stage3.txt

- name: install latest version of SAPPHiRE
  pip: virtualenv=/srv/publicdb/publicdb_env state=latest
       name=https://github.com/HiSPARC/sapphire/archive/master.zip

- name: set up MySQL database
  mysql_db: name=publicdb state=present

- name: set up MySQL user
  mysql_user: name=hisparc password={{ mysql_password }}
              priv=publicdb.*:ALL state=present

- name: copy Django settings file
  copy: src=settings.py dest=/srv/publicdb/www/django_publicdb/settings.py
        backup=yes

- name: synchronize Django database
  shell: chdir=/srv/publicdb/www
         yes 'no' | /srv/publicdb/publicdb_env/bin/python manage.py syncdb

- name: migrate Django apps
  command: chdir=/srv/publicdb/www
           /srv/publicdb/publicdb_env/bin/python manage.py migrate

- name: collect static files of Django apps
  shell: chdir=/srv/publicdb/www
         yes 'yes' |
         /srv/publicdb/publicdb_env/bin/python manage.py collectstatic

- name: copy uwsgi.ini
  copy: src=uwsgi.ini dest=/srv/publicdb/www/uwsgi.ini backup=yes
