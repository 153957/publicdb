- name: ensure /srv directory exists
  file: path=/srv state=directory
  sudo: yes

- name: ensure /srv/publicdb directory exists
  file: path=/srv/publicdb state=directory
        owner=hisparc group=hisparc mode=2775
  sudo: yes

- name: set default group write ACLs on /srv/publicdb
  command: /usr/bin/setfacl -m d:g::rwx /srv/publicdb
  sudo: yes

- name: checkout publicdb in /srv/publicdb/www
  git: repo=https://github.com/HiSPARC/publicdb.git dest=/srv/publicdb/www
       update=yes force=no

- name: create django static folder
  file: path=/srv/publicdb/static state=directory

- name: Copy pip requirements files
  copy: src=pip-stage1.txt dest=/home/{{ ansible_user_id }}/

- name: Copy pip requirements files
  copy: src=pip-stage2.txt dest=/home/{{ ansible_user_id }}/

- name: Copy pip requirements files
  copy: src=pip-stage3.txt dest=/home/{{ ansible_user_id }}/

- name: Copy pip requirements files
  copy: src=pip-stage4.txt dest=/home/{{ ansible_user_id }}/

- name: install python packages in virtualenv -- stage 1
  pip: virtualenv=/srv/publicdb/publicdb_env
       requirements=/home/{{ ansible_user_id }}/pip-stage1.txt

- name: install python packages in virtualenv -- stage 2
  pip: virtualenv=/srv/publicdb/publicdb_env
       requirements=/home/{{ ansible_user_id }}/pip-stage2.txt

- name: install python packages in virtualenv -- stage 3
  pip: virtualenv=/srv/publicdb/publicdb_env
       requirements=/home/{{ ansible_user_id }}/pip-stage3.txt

- name: install latest version of SAPPHiRE in virtualenv
  pip: virtualenv=/srv/publicdb/publicdb_env
       requirements=/home/{{ ansible_user_id }}/pip-stage4.txt

- name: set up MySQL database
  mysql_db: name=publicdb state=present

- name: set up MySQL user
  mysql_user: name=hisparc password={{ mysql_password }}
              priv=publicdb.*:ALL state=present

- name: copy Django settings file
  copy: src=settings.py dest=/srv/publicdb/www/django_publicdb/settings.py
        backup=yes

- name: synchronize Django database
  shell: chdir=/srv/publicdb/www/django_publicdb
         yes 'no' | /srv/publicdb/publicdb_env/bin/python manage.py syncdb

- name: migrate Django apps
  command: chdir=/srv/publicdb/www/django_publicdb
           /srv/publicdb/publicdb_env/bin/python manage.py migrate

- name: collect static files of Django apps
  shell: chdir=/srv/publicdb/www/django_publicdb
         yes 'yes' |
         /srv/publicdb/publicdb_env/bin/python manage.py collectstatic

- name: copy uwsgi.ini
  copy: src=uwsgi.ini dest=/srv/publicdb/www/uwsgi.ini backup=yes

- name: install supervisor daemon
  yum: name=supervisor
  sudo: yes

- name: copy supervisord.conf
  copy: src=supervisord.conf dest=/etc/supervisord.conf backup=yes
  sudo: yes

- name: start supervisord now and on boot
  service: name=supervisord state=started enabled=yes
  sudo: yes

- name: start uWSGI
  supervisorctl: name=uwsgi state=restarted
