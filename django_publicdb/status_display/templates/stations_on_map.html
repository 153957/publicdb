{% extends 'base_stations.html' %}

{% load url from future %}

{% block head_styles %}
    <link rel="stylesheet" type="text/css" media="screen" href="{{ STATIC_URL }}styles/stations.css" />
{% endblock %}

{% block head %}
    <script type="text/javascript">
        var pointStyle = {
            fillColor: '#1BAF16',
            fillOpacity: 0.7,
            pointRadius: 3,
            stroke: false};
        var pointStyle_down = $.extend(true, {}, pointStyle, {fillColor:'#F00'});
        var pointStyle_problem = $.extend(true, {}, pointStyle, {fillColor:'#FFD700'});
        var pointStyle_up = $.extend(true, {}, pointStyle, {fillColor:'#008000'});
        var pointStyle_unknown = $.extend(true, {}, pointStyle, {fillColor:'#00F'});

        $(document).ready(function() {
            var fromProjection = new OpenLayers.Projection("EPSG:4326"); // transform from WGS 1984
            var toProjection = new OpenLayers.Projection("EPSG:900913"); // to Spherical Mercator Projection
            var options = {
                controls: [
                    new OpenLayers.Control.Navigation(
                        {dragPanOptions: {enableKinetic: true}}),
                    new OpenLayers.Control.Attribution(),
                    new OpenLayers.Control.ScaleLine()]};
            var map = new OpenLayers.Map("stationMap", options);
            var mapLayer = new OpenLayers.Layer.OSM();
            map.addLayer(mapLayer);

            map.setCenter(new OpenLayers.LonLat(4.950, 52.355).transform(fromProjection, toProjection), 5);

            var stationLayer = new OpenLayers.Layer.Vector("stations");
            {% for station in stations %}
              {% if station.longitude and station.latitude %} 
            var feature = new OpenLayers.Feature.Vector(
                new OpenLayers.Geometry.Point({{ station.longitude }}, {{ station.latitude }})
                                       .transform(fromProjection, toProjection),
                {id: {{ station.number }},
                 name: "{{ station.name }}",
                 cluster: "{{ station.cluster }}",
                 link: {{ station.link }}},
                pointStyle_{{ station.status }});
            stationLayer.addFeatures(feature);
              {% endif %}
            {% endfor %}
            map.addLayer(stationLayer);
            
            var layer_style = OpenLayers.Util.extend({}, OpenLayers.Feature.Vector.style['default']);

            map.events.register('zoomend', this, function(event) {
                var zLevel = map.getZoom();
                if (zLevel <= 5) {
                    setPointRadius(3);}
                else if (zLevel <= 8) {
                    setPointRadius(4);}
                else if (zLevel <= 11) {
                    setPointRadius(5);}
                else if (zLevel <= 14) {
                    setPointRadius(6);}
                else if (zLevel <= 16) {
                    setPointRadius(7);}
                else if (zLevel <= 18) {
                    setPointRadius(8);}
            });

            var selectControl = new OpenLayers.Control.SelectFeature(
                [stationLayer],
                {clickout: true, toggle: false, multiple: false, hover: false,
                 toggleKey: "ctrlKey", multipleKey: "shiftKey"});
            map.addControl(selectControl);
            selectControl.activate();
            
            stationLayer.events.on({
                "featureselected": function(e) {
                    var attr = e.feature.attributes
                    stationInfo("Station: <a href='../stations/" + attr.link + "'> " + attr.name +
                                " (" + attr.id + ")</a><br />Cluster: " + attr.cluster);}});
        });

        function setPointRadius(size) {
            $('circle').attr('r', size.toString());
            pointStyle.pointRadius = size;
            pointStyle_down.pointRadius = size;
            pointStyle_problem.pointRadius = size;
            pointStyle_up.pointRadius = size;
            pointStyle_unknown.pointRadius = size;
        }

        function stationInfo(text) {
            $('#selectedStation').html(text);            
        }
    </script>
{% endblock %}

{% block header %}
    Map of stations
{% endblock %}

{% block intro %}
    The following is a map with all stations shown on it, based on their last known GPS location.
    Clicking on a station will show some info about it and give you a link to its data page.
    The color of a station indicates its current status:
    <span class='statusBall down'></span> down,
    <span class='statusBall problem'></span> problem,
    <span class='statusBall up'></span> up,
    <span class='statusBall unknown' style="visibility: visible;"></span> unknown.</p>
{% endblock %}

{% block map %}
<div id="stationMap">
</div>

<div id="selectedStation">
</div>
{% endblock %}
