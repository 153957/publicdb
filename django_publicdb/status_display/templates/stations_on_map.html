{% extends 'base.html' %}

{% load url from future %}

{% block head %}
    <link rel="stylesheet" type="text/css" media="screen" href="{{ STATIC_URL }}styles/stations.css" />
    <script type="text/javascript" src="{{ STATIC_URL }}scripts/OpenLayers-2.12/OpenLayers.js"></script>
    <script type="text/javascript">

        $(document).ready(function() {
            var fromProjection = new OpenLayers.Projection("EPSG:4326"); // transform from WGS 1984
            var toProjection = new OpenLayers.Projection("EPSG:900913"); // to Spherical Mercator Projection
            var options = {
                controls: [
                    new OpenLayers.Control.Navigation(),
                    new OpenLayers.Control.Attribution(),
                    new OpenLayers.Control.ScaleLine()
                ]
            };
            map = new OpenLayers.Map("stationMap", options);
            var mapLayer = new OpenLayers.Layer.OSM();
            map.addLayer(mapLayer);
            map.setCenter(new OpenLayers.LonLat(4.950, 52.355)
                                        .transform(fromProjection, toProjection), 5);

            var stationLayer = new OpenLayers.Layer.Vector("stations");
            {% for station in stations %}
            {% if station.longitude and station.latitude %} 
            var feature = new OpenLayers.Feature.Vector(
                new OpenLayers.Geometry.Point({{ station.longitude }}, {{ station.latitude }})
                                       .transform(fromProjection, toProjection),
                {id: {{ station.number }},
                 name: "{{ station.name }}",
                 link: {{ station.link }}},
                {fillColor: '#3143D1',
                 fillOpacity: 0.8,
                 pointRadius: 4,
                 stroke: false,
                });
            stationLayer.addFeatures(feature);
            {% endif %}
            {% endfor %}
            map.addLayer(stationLayer);

            selectControl = new OpenLayers.Control.SelectFeature(
                [stationLayer],
                {clickout: true, toggle: false, multiple: false, hover: false,
                 toggleKey: "ctrlKey", multipleKey: "shiftKey"
                }
            );
            map.addControl(selectControl);
            selectControl.activate();
            
            stationLayer.events.on({
                "featureselected": function(e) {
                    attr = e.feature.attributes
                    stationInfo("Station: <a href='../stations/" + attr.link + "'> " + attr.name +
                                " (" + attr.id + ")</a>"
                    );
                },

            });
        });

        function stationInfo(text) {
            $('#selectedStation').html(text);            
        }
    </script>

{% endblock %}

{% block content %}

<div id="stationListPages">
    Station Lists:<br />
    <a href="../stations" target="_top">order by cluster</a><br />
    <a href="../stations_by_number" target="_top">order by number</a><br />
    <a href="../stations_by_name" target="_top">order by name</a><br />
    <a href="../stations_on_map" target="_top">stations on map</a>
</div>

<div id="header">
    <h2>Map of stations</h2>
</div>

<div id="intro">
    <p>The following is a map with all active stations shown on it, based on their last known GPS location.
    Clicking on a station will show some info about it and give you a link to its data page.</p>
</div>

<div id="stationMap">
</div>

<div id="selectedStation">
</div>

{% endblock %}
