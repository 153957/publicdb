{% extends 'base_stations.html' %}

{% load url from future %}
{% load fix_strings %}

{% block current_mapcluster %}{% if focus %}currentPage{% endif %}{% endblock %}
{% block current_map %}{% if not focus %}currentPage{% endif %}{% endblock %}

{% block head %}
    <script type="text/javascript">
        $(document).ready(function() {
            var fromProjection = new OpenLayers.Projection("EPSG:4326"); // transform from WGS 1984
            var toProjection = new OpenLayers.Projection("EPSG:900913"); // to Spherical Mercator Projection
            var options = {
                controls: [
                    new OpenLayers.Control.Navigation(
                        {dragPanOptions: {enableKinetic: true}}),
                    new OpenLayers.Control.Attribution(),
                    new OpenLayers.Control.ScaleLine()]};
            var map = new OpenLayers.Map("stationMap", options);
            var mapLayer = new OpenLayers.Layer.OSM();
            map.addLayer(mapLayer);
            var colors = {"down": 'red',
                          "problem": 'gold',
                          "up": 'green',
                          "unknown": 'blue'};
            var context = {
                getColor: function(feature) {
                    return colors[feature.attributes["status"]];},
                getLabel: function(feature) {
                    if (map.getZoom() >= 14) {
                        return feature.attributes["id"];}
                    else {
                        return ''}},
                getSize: function(feature) {
                    return .5 * map.getZoom();}};
            var pointStyle = {
                fillColor: "${getColor}", // using context.getColor(feature)
                fillOpacity: 0.8,
                strokeColor: "black",
                strokeOpacity: 0.75,
                strokeWidth: 1,
                pointRadius: "${getSize}", // using context.getSize(feature)
                cursor: 'pointer',
                label: '${getLabel}', // using context.getLabel(feature)
                labelYOffset: 16,
                fontSize: 12,
                fontFamily: 'sans-serif',
                fontWeight: 'bold'};
            var style = new OpenLayers.Style(pointStyle, {context: context});

            map.setCenter(new OpenLayers.LonLat(4.950, 52.355).transform(fromProjection, toProjection), 5);
            {% for cluster in clusters %}
                var {{ cluster.name|slugify|remove_hyphens }} = new OpenLayers.Layer.Vector("{{ cluster.name }}", {styleMap: new OpenLayers.StyleMap(style)});
                    {% for station in cluster.stations %}
                        {% if station.longitude and station.latitude %} 
                            var feature = new OpenLayers.Feature.Vector(
                                new OpenLayers.Geometry.Point({{ station.longitude }}, {{ station.latitude }})
                                                       .transform(fromProjection, toProjection),
                                {id: {{ station.number }},
                                 name: "{{ station.name }}",
                                 subcluster: "{{ station.cluster }}",
                                 cluster: "{{ station.cluster.parent }}",
                                 link: {{ station.link }},
                                 status: "{{ station.status }}"});
                            {{ cluster.name|slugify|remove_hyphens }}.addFeatures(feature);
                        {% endif %}
                    {% endfor %}
                map.addLayer({{ cluster.name|slugify|remove_hyphens }});
            {% endfor %}
            // Zoom to fit cluster
            {% if focus %}
                var bounds = {{ focus|slugify|remove_hyphens }}.getDataExtent();
                if (bounds) {map.zoomToExtent(bounds);}
            {% endif %}
            var layer_style = OpenLayers.Util.extend({}, OpenLayers.Feature.Vector.style['default']);
            var selectControl = new OpenLayers.Control.SelectFeature(
                [{% for cluster in clusters %}
                    {{ cluster.name|slugify|remove_hyphens }}{% if not forloop.last %},{% endif %}
                 {% endfor %}],
                {clickout: true, hover: false});
            map.addControl(selectControl);
            selectControl.activate();
            {% for cluster in clusters %}
                {{ cluster.name|slugify|remove_hyphens }}.events.on({
                    "featureselected": function(e) {showStationInfo(e);}});
            {% endfor %}
        });

        function showStationInfo(e) {
            var attr = e.feature.attributes
            stationLink("<a href='{% url 'status_display.views.stations' %}" + attr.link + "/status'><span class='statusBall " + attr.status + "'></span></a>" +
                        "<a href='{% url 'status_display.views.stations' %}" + attr.link + "'> " + attr.name + " (" + attr.id + ")</a>");

            if (attr.cluster == "None") {cluster = ""}
            else {cluster = " (" + attr.cluster + ")"}
            clusterLink("<a href='{% url 'status_display.views.stations_on_map' %}" + attr.subcluster + "'> " + attr.subcluster + cluster + "</a>");}

        function stationLink(text) {
            $('#stationLink').html(text);}

        function clusterLink(text) {
            $('#clusterLink').html(text);}
    </script>
{% endblock %}

{% block header %}
    Map of HiSPARC stations
{% endblock %}

{% block map %}
    <div id="stationMap"></div>
{% endblock %}

{% block sidebar %}
    <div class="sectionTitle">Selected Station</div>
    <div class="keyvalue">
        <span class="key">Station</span><br />
        <span class="value" id="stationLink"><span class="statusBall"></span> None</span>
    </div>
    <div class="keyvalue">
        <span class="key">Cluster</span><br />
        <span class="value" id="clusterLink">None</span>
    </div>
{% endblock %}
